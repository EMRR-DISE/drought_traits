---
title: "Drought Trait-based study: Sample locations"
author: "Dave Bosworth"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document provides an interactive map of the sampling locations used in the trait-based special study for the Drought Synthesis. 

# Global code and functions

```{r load packages, message = FALSE, warning = FALSE}
# Load packages
library(tidyverse)
library(readxl)
library(sf)
library(leaflet)
library(here)

# Check if we are in the correct working directory
i_am("Sample_Location_Map.Rmd")
```


# Import and Prepare Data

```{r import data}
# Define absolute file path for station coordinate data on Drought Synthesis SharePoint
fp_drt <- "California Department of Water Resources/Drought Synthesis - Documents"
fp_coord <- normalizePath(file.path(Sys.getenv('USERPROFILE'), fp_drt, "Special Studies Synthesis/Data/Metadata/Station_Metadata.xlsx"))
  
# Import station coordinates 
df_coord <- read_excel(path = fp_coord, sheet = "Data")

# Prepare station coordinates for leaflet map
sf_coord <- df_coord %>% 
  select(
    taxon,
    program,
    station,
    latitude = lat_wgs84,
    longitude = long_wgs84
  ) %>% 
  drop_na(latitude, longitude) %>% 
  filter(program %in% c("EMP", "MWTR")) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Import Region polygon
sf_region <- read_sf(here("spatial_files/region.shp"))

# Convert CRS of Region polygon to WGS84 so that it works with the leaflet map
sf_region_4326 <- st_transform(sf_region, crs = 4326)
```


# Sampling Locations Map

This interactive map allows for zooming and panning. Hover over a station marker to get more information about it. The blue polygon represents the region boundary we are considering for the spatial extent of the study.

```{r create leaflet map}
# Define color palette for Surveys 
color_pal <- colorFactor(palette = "viridis", domain = sf_coord$taxon)

# Create map using leaflet
leaflet() %>% 
  addTiles() %>%
  addCircleMarkers(
    data = sf_coord,
    radius = 5,
    fillColor = ~color_pal(taxon),
    fillOpacity = 0.8,
    weight = 0.5,
    color = "black",
    opacity = 1,
    label = paste0("Station: ", sf_coord$station)
  ) %>% 
  addPolylines(data = sf_region_4326) %>%
  addLegend(
    position = "topright",
    pal = color_pal,
    values = sf_coord$taxon,
    title = "Taxon"
  )
```

